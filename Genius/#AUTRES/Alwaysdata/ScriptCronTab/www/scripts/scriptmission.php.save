<?php
/**
 * Created by PhpStorm.
 * User: Nathan BERNARD
 * Date: 05/06/2018
 * Time: 10:04
 */
require_once "configuration.php";

//Connexion à la base de Données

$connexion = mysqli_connect($host,$login,$password,$database);
if (!$connexion) {
    die('Erreur de connexion : ' . mysqli_connect_error());
}
//Supprime toutes les missions présentes
$requete = "DELETE FROM `present_missions` WHERE 1";
if($result = mysqli_query($connexion,$requete)){
    echo "ça a marché la suppression <br><br>";
}
else{
    echo "ça a pas marché <br><br>";
}

//Récupère tout les ID de chaque mission
$listeMissions = array();
$requete = "SELECT * FROM mission";
if($result = mysqli_query($connexion,$requete)){
    while ($tuple = mysqli_fetch_assoc($result)){
        array_push($listeMissions,$tuple['IDMission']);
	//echo "ID = ".$tuple['IDMission'];
    }
}
else{
    echo "ça a pas marché dans la query";
}

//Récupère nombre total de quartier
$requete = "SELECT Count(*) AS Total, IDDistrict FROM district";
if($result = mysqli_query($connexion,$requete)){
    while ($tuple = mysqli_fetch_assoc($result)){
        $totalquartier = (int)$tuple['Total'];
        //echo $totalquartier." nombre total de quartier<br><br>";
    }
}
else{
    echo "ça a pas marché dans la query";
}

//Génère et récupère le nombre de missions par quartier
$totaldemissions = 0;
$tabNbMissionParQuartier = array();
for($i = 0 ; $i<$totalquartier; ++$i)
{
    if($i==0){
        $randomNbMission = 0;
    }
    else{
        $randomNbMission = random_int(1,4);
    }
    $tabNbMissionParQuartier[$i] = $randomNbMission;
    echo "Nombre de missions = ".$randomNbMission." pour le quartier ->".$i."<br><br>";
    $totaldemissions += $randomNbMission;
}

$missiondejala = array();

for($i=0; $i<sizeof($tabNbMissionParQuartier) ; ++$i)
{
    while ($tabNbMissionParQuartier[$i]>0)
    {
        $dejala = false;
        $randMission = rand(0,sizeof($listeMissions));
        $missionchoisi = $listeMissions[$randMission];
        for ($j = 0; $j<sizeof($missiondejala); ++$j)
        {
            if($missionchoisi == $missiondejala[$j]){
                $dejala = true;
                break;
            }
        }
        if ($dejala == true)
        {
            continue;
        }
        else
        {
            array_push($missiondejala,$missionchoisi);
            $requete = "INSERT INTO present_missions(IDDistrict,IDMission) VALUE (".$i.",".$missionchoisi.");";
            if($result = mysqli_query($connexion,$requete)){
                echo "ça a marché <br><br>";
            }
            else{
                echo "ça a pas marché <br><br>";
            }
            $tabNbMissionParQuartier[$i] -= 1;
        }
    }
}

